<!DOCTYPE html><html lang="en"><head><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fashion Listing Assistant</title>
    
    <!-- PWA Configuration -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Fashion Assistant">
    <meta name="theme-color" content="#5D5CDE">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9IiM1RDVDREUiLz4KPHN2ZyB4PSI0OCIgeT0iNDgiIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiPgo8cGF0aCBkPSJtMTYgNiA0IDZoLTRWNnoiLz4KPHN2ZyB4PSI0OCIgeT0iNDgiIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiPgo8L3N2Zz4KPC9zdmc+">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        'primary-hover': '#4F4ED6',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-white dark:bg-gray-900 min-h-screen">
    <script>
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>

    <div class="container mx-auto px-4 py-8 max-w-3xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Fashion Listing Assistant</h1>
            <p class="text-gray-600 dark:text-gray-400">Quick &amp; affordable vintage fashion listings</p>
            
            <!-- API Key Section -->
            <div class="mt-4 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800 max-w-md mx-auto">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-sm font-medium text-blue-900 dark:text-blue-100">🔑 OpenAI API Key</h3>
                    <button id="toggle-api-key" class="text-xs text-blue-600 dark:text-blue-400 hover:underline">Enter Key</button>
                </div>
                <div id="api-key-status" class="text-xs text-blue-700 dark:text-blue-300">No API key set - click "Enter Key" to add yours</div>
                <div id="api-key-input" class="hidden mt-2">
                    <input type="password" id="api-key-field" placeholder="sk-proj-..." class="w-full px-2 py-1 text-sm border border-blue-300 dark:border-blue-600 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 dark:bg-blue-900/50 dark:text-white">
                    <div class="flex gap-2 mt-2">
                        <button id="save-api-key" class="flex-1 px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">Save</button>
                        <button id="clear-api-key" class="px-3 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600">Clear</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Item Details Form -->
        <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">Describe Your Item</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Item Type *</label>
                    <select id="item-type" required="" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
                        <option value="">Select item type...</option>
                        
                        <!-- CLOTHING -->
                        <optgroup label="👗 Dresses">
                            <option value="Dress">Dress</option>
                            <option value="Midi Dress">Midi Dress</option>
                            <option value="Maxi Dress">Maxi Dress</option>
                            <option value="Mini Dress">Mini Dress</option>
                            <option value="Party Dress">Party Dress</option>
                            <option value="Wedding Dress">Wedding Dress</option>
                            <option value="Cocktail Dress">Cocktail Dress</option>
                        </optgroup>
                        
                        <optgroup label="👚 Tops">
                            <option value="Blouse">Blouse</option>
                            <option value="Vintage Blouse">Vintage Blouse</option>
                            <option value="Shirt">Shirt</option>
                            <option value="Button-up Shirt">Button-up Shirt</option>
                            <option value="Top">Top</option>
                            <option value="Tank Top">Tank Top</option>
                            <option value="Camisole">Camisole</option>
                            <option value="Crop Top">Crop Top</option>
                            <option value="T-shirt">T-shirt</option>
                            <option value="Polo Shirt">Polo Shirt</option>
                        </optgroup>
                        
                        <optgroup label="🧥 Outerwear">
                            <option value="Sweater">Sweater</option>
                            <option value="Vintage Sweater">Vintage Sweater</option>
                            <option value="Cardigan">Cardigan</option>
                            <option value="Hoodie">Hoodie</option>
                            <option value="Sweatshirt">Sweatshirt</option>
                            <option value="Jacket">Jacket</option>
                            <option value="Leather Jacket">Leather Jacket</option>
                            <option value="Denim Jacket">Denim Jacket</option>
                            <option value="Bomber Jacket">Bomber Jacket</option>
                            <option value="Blazer">Blazer</option>
                            <option value="Vintage Blazer">Vintage Blazer</option>
                            <option value="Coat">Coat</option>
                            <option value="Trench Coat">Trench Coat</option>
                            <option value="Puffer Jacket">Puffer Jacket</option>
                            <option value="Vest">Vest</option>
                        </optgroup>
                        
                        <optgroup label="👖 Bottoms">
                            <option value="Skirt">Skirt</option>
                            <option value="Midi Skirt">Midi Skirt</option>
                            <option value="Mini Skirt">Mini Skirt</option>
                            <option value="A-line Skirt">A-line Skirt</option>
                            <option value="Pleated Skirt">Pleated Skirt</option>
                            <option value="Pants">Pants</option>
                            <option value="Trousers">Trousers</option>
                            <option value="Wide Leg Pants">Wide Leg Pants</option>
                            <option value="High Waisted Pants">High Waisted Pants</option>
                            <option value="Jeans">Jeans</option>
                            <option value="Vintage Jeans">Vintage Jeans</option>
                            <option value="Mom Jeans">Mom Jeans</option>
                            <option value="Skinny Jeans">Skinny Jeans</option>
                            <option value="Shorts">Shorts</option>
                            <option value="Denim Shorts">Denim Shorts</option>
                            <option value="Leggings">Leggings</option>
                            <option value="Joggers">Joggers</option>
                        </optgroup>
                        
                        <optgroup label="👔 Sets &amp; Suits">
                            <option value="Suit">Suit</option>
                            <option value="Vintage Suit">Vintage Suit</option>
                            <option value="Two Piece Set">Two Piece Set</option>
                            <option value="Co-ord Set">Co-ord Set</option>
                            <option value="Matching Set">Matching Set</option>
                            <option value="Jumpsuit">Jumpsuit</option>
                            <option value="Playsuit">Playsuit</option>
                            <option value="Romper">Romper</option>
                        </optgroup>
                        
                        <!-- ACCESSORIES -->
                        <optgroup label="👜 Bags">
                            <option value="Handbag">Handbag</option>
                            <option value="Shoulder Bag">Shoulder Bag</option>
                            <option value="Crossbody Bag">Crossbody Bag</option>
                            <option value="Tote Bag">Tote Bag</option>
                            <option value="Clutch">Clutch</option>
                            <option value="Evening Bag">Evening Bag</option>
                            <option value="Backpack">Backpack</option>
                            <option value="Mini Bag">Mini Bag</option>
                            <option value="Vintage Bag">Vintage Bag</option>
                            <option value="Designer Bag">Designer Bag</option>
                            <option value="Laptop Bag">Laptop Bag</option>
                            <option value="Travel Bag">Travel Bag</option>
                            <option value="Gym Bag">Gym Bag</option>
                            <option value="Bucket Bag">Bucket Bag</option>
                            <option value="Saddle Bag">Saddle Bag</option>
                        </optgroup>
                        
                        <optgroup label="👠 Shoes">
                            <option value="Heels">Heels</option>
                            <option value="High Heels">High Heels</option>
                            <option value="Block Heels">Block Heels</option>
                            <option value="Stilettos">Stilettos</option>
                            <option value="Wedges">Wedges</option>
                            <option value="Pumps">Pumps</option>
                            <option value="Flats">Flats</option>
                            <option value="Ballet Flats">Ballet Flats</option>
                            <option value="Loafers">Loafers</option>
                            <option value="Mules">Mules</option>
                            <option value="Sandals">Sandals</option>
                            <option value="Strappy Sandals">Strappy Sandals</option>
                            <option value="Platform Sandals">Platform Sandals</option>
                            <option value="Slides">Slides</option>
                            <option value="Boots">Boots</option>
                            <option value="Ankle Boots">Ankle Boots</option>
                            <option value="Knee High Boots">Knee High Boots</option>
                            <option value="Over Knee Boots">Over Knee Boots</option>
                            <option value="Combat Boots">Combat Boots</option>
                            <option value="Chelsea Boots">Chelsea Boots</option>
                            <option value="Cowboy Boots">Cowboy Boots</option>
                            <option value="Sneakers">Sneakers</option>
                            <option value="Trainers">Trainers</option>
                            <option value="Running Shoes">Running Shoes</option>
                            <option value="Canvas Shoes">Canvas Shoes</option>
                            <option value="Vintage Shoes">Vintage Shoes</option>
                            <option value="Designer Shoes">Designer Shoes</option>
                        </optgroup>
                        
                        <optgroup label="💍 Jewelry">
                            <option value="Necklace">Necklace</option>
                            <option value="Pendant Necklace">Pendant Necklace</option>
                            <option value="Chain Necklace">Chain Necklace</option>
                            <option value="Statement Necklace">Statement Necklace</option>
                            <option value="Choker">Choker</option>
                            <option value="Earrings">Earrings</option>
                            <option value="Stud Earrings">Stud Earrings</option>
                            <option value="Hoop Earrings">Hoop Earrings</option>
                            <option value="Drop Earrings">Drop Earrings</option>
                            <option value="Statement Earrings">Statement Earrings</option>
                            <option value="Bracelet">Bracelet</option>
                            <option value="Chain Bracelet">Chain Bracelet</option>
                            <option value="Bangle">Bangle</option>
                            <option value="Ring">Ring</option>
                            <option value="Statement Ring">Statement Ring</option>
                            <option value="Vintage Jewelry">Vintage Jewelry</option>
                            <option value="Costume Jewelry">Costume Jewelry</option>
                            <option value="Fine Jewelry">Fine Jewelry</option>
                            <option value="Gold Jewelry">Gold Jewelry</option>
                            <option value="Silver Jewelry">Silver Jewelry</option>
                        </optgroup>
                        
                        <optgroup label="🎩 Hats &amp; Hair">
                            <option value="Hat">Hat</option>
                            <option value="Beanie">Beanie</option>
                            <option value="Baseball Cap">Baseball Cap</option>
                            <option value="Bucket Hat">Bucket Hat</option>
                            <option value="Beret">Beret</option>
                            <option value="Fedora">Fedora</option>
                            <option value="Sun Hat">Sun Hat</option>
                            <option value="Winter Hat">Winter Hat</option>
                            <option value="Vintage Hat">Vintage Hat</option>
                            <option value="Hair Accessories">Hair Accessories</option>
                            <option value="Hair Clips">Hair Clips</option>
                            <option value="Headband">Headband</option>
                            <option value="Scrunchies">Scrunchies</option>
                        </optgroup>
                        
                        <optgroup label="🧣 Scarves &amp; Wraps">
                            <option value="Scarf">Scarf</option>
                            <option value="Silk Scarf">Silk Scarf</option>
                            <option value="Winter Scarf">Winter Scarf</option>
                            <option value="Cashmere Scarf">Cashmere Scarf</option>
                            <option value="Vintage Scarf">Vintage Scarf</option>
                            <option value="Designer Scarf">Designer Scarf</option>
                            <option value="Shawl">Shawl</option>
                            <option value="Wrap">Wrap</option>
                            <option value="Pashmina">Pashmina</option>
                            <option value="Bandana">Bandana</option>
                        </optgroup>
                        
                        <optgroup label="👓 Eyewear">
                            <option value="Sunglasses">Sunglasses</option>
                            <option value="Vintage Sunglasses">Vintage Sunglasses</option>
                            <option value="Designer Sunglasses">Designer Sunglasses</option>
                            <option value="Cat Eye Sunglasses">Cat Eye Sunglasses</option>
                            <option value="Aviator Sunglasses">Aviator Sunglasses</option>
                            <option value="Round Sunglasses">Round Sunglasses</option>
                            <option value="Glasses">Glasses</option>
                            <option value="Reading Glasses">Reading Glasses</option>
                        </optgroup>
                        
                        <optgroup label="📱 Tech &amp; Accessories">
                            <option value="Watch">Watch</option>
                            <option value="Vintage Watch">Vintage Watch</option>
                            <option value="Designer Watch">Designer Watch</option>
                            <option value="Smart Watch">Smart Watch</option>
                            <option value="Phone Case">Phone Case</option>
                            <option value="Wallet">Wallet</option>
                            <option value="Purse">Purse</option>
                            <option value="Card Holder">Card Holder</option>
                            <option value="Key Chain">Key Chain</option>
                        </optgroup>
                        
                        <optgroup label="👔 Other Accessories">
                            <option value="Belt">Belt</option>
                            <option value="Leather Belt">Leather Belt</option>
                            <option value="Chain Belt">Chain Belt</option>
                            <option value="Designer Belt">Designer Belt</option>
                            <option value="Vintage Belt">Vintage Belt</option>
                            <option value="Gloves">Gloves</option>
                            <option value="Leather Gloves">Leather Gloves</option>
                            <option value="Winter Gloves">Winter Gloves</option>
                            <option value="Tie">Tie</option>
                            <option value="Bow Tie">Bow Tie</option>
                            <option value="Pocket Square">Pocket Square</option>
                            <option value="Cufflinks">Cufflinks</option>
                        </optgroup>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Brand</label>
                    <input type="text" id="brand" placeholder="e.g., Zara, COS, Arket, Uniqlo, Vintage, No brand" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Size *</label>
                    <input type="text" id="size" required="" placeholder="e.g., S, M, L, 8, 10, 12, EU38" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Era/Decade</label>
                    <select id="era" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
                        <option value="">Select era...</option>
                        <option value="2020s">2020s</option>
                        <option value="2010s">2010s</option>
                        <option value="2000s">2000s / Y2K</option>
                        <option value="90s">90s</option>
                        <option value="80s">80s</option>
                        <option value="70s">70s</option>
                        <option value="60s">60s</option>
                        <option value="50s">50s</option>
                        <option value="40s and earlier">40s and earlier</option>
                        <option value="Unspecified Vintage">Unspecified Vintage</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Primary Material *</label>
                    <select id="material1" required="" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
                        <option value="">Select primary material...</option>
                        <option value="Cotton">Cotton</option>
                        <option value="Wool">Wool</option>
                        <option value="Silk">Silk</option>
                        <option value="Linen">Linen</option>
                        <option value="Cashmere">Cashmere</option>
                        <option value="Leather">Leather</option>
                        <option value="Suede">Suede</option>
                        <option value="Denim">Denim</option>
                        <option value="Polyester">Polyester</option>
                        <option value="Viscose">Viscose</option>
                        <option value="Rayon">Rayon</option>
                        <option value="Nylon">Nylon</option>
                        <option value="Acrylic">Acrylic</option>
                        <option value="Elastane">Elastane</option>
                        <option value="Tencel">Tencel</option>
                        <option value="Modal">Modal</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Secondary Material</label>
                    <select id="material2" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
                        <option value="">None / Single material</option>
                        <option value="Cotton">Cotton</option>
                        <option value="Wool">Wool</option>
                        <option value="Silk">Silk</option>
                        <option value="Linen">Linen</option>
                        <option value="Polyester">Polyester</option>
                        <option value="Viscose">Viscose</option>
                        <option value="Elastane">Elastane</option>
                        <option value="Spandex">Spandex</option>
                        <option value="Nylon">Nylon</option>
                        <option value="Acrylic">Acrylic</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Condition *</label>
                    <select id="condition" required="" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
                        <option value="">Select condition...</option>
                        <option value="BNWT">BNWT (Brand New With Tags)</option>
                        <option value="NWOT">NWOT (New Without Tags)</option>
                        <option value="Very good">Very good</option>
                        <option value="Good">Good</option>
                        <option value="Satisfactory">Satisfactory</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Fit</label>
                    <select id="fit" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
                        <option value="">Select fit...</option>
                        <option value="Oversized">Oversized</option>
                        <option value="Relaxed">Relaxed</option>
                        <option value="Regular fit">Regular fit</option>
                        <option value="Slim fit">Slim fit</option>
                        <option value="Tailored">Tailored</option>
                        <option value="High waisted">High waisted</option>
                        <option value="Low waisted">Low waisted</option>
                        <option value="A-line">A-line</option>
                        <option value="Straight">Straight</option>
                        <option value="Wide leg">Wide leg</option>
                        <option value="Bodycon">Bodycon</option>
                        <option value="Flowy">Flowy</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Length</label>
                    <select id="length" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
                        <option value="">Select length...</option>
                        <option value="Cropped">Cropped</option>
                        <option value="Regular length">Regular length</option>
                        <option value="Long">Long</option>
                        <option value="Mini length">Mini length</option>
                        <option value="Above knee">Above knee</option>
                        <option value="Knee length">Knee length</option>
                        <option value="Midi length">Midi length</option>
                        <option value="Maxi length">Maxi length</option>
                        <option value="Floor length">Floor length</option>
                        <option value="Ankle length">Ankle length</option>
                        <option value="Full length">Full length</option>
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Color * (select up to 2)</label>
                    <div id="color-grid" class="grid grid-cols-3 md:grid-cols-4 gap-2 p-3 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 max-h-48 overflow-y-auto">
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 p-1 rounded text-sm">
                            <input type="checkbox" value="Black" class="color-checkbox rounded border-gray-300 text-primary focus:ring-primary focus:ring-2">
                            <span class="text-gray-700 dark:text-gray-300">Black</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 p-1 rounded text-sm">
                            <input type="checkbox" value="Brown" class="color-checkbox rounded border-gray-300 text-primary focus:ring-primary focus:ring-2">
                            <span class="text-gray-700 dark:text-gray-300">Brown</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 p-1 rounded text-sm">
                            <input type="checkbox" value="Grey" class="color-checkbox rounded border-gray-300 text-primary focus:ring-primary focus:ring-2">
                            <span class="text-gray-700 dark:text-gray-300">Grey</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 p-1 rounded text-sm">
                            <input type="checkbox" value="Beige" class="color-checkbox rounded border-gray-300 text-primary focus:ring-primary focus:ring-2">
                            <span class="text-gray-700 dark:text-gray-300">Beige</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 p-1 rounded text-sm">
                            <input type="checkbox" value="Pink" class="color-checkbox rounded border-gray-300 text-primary focus:ring-primary focus:ring-2">
                            <span class="text-gray-700 dark:text-gray-300">Pink</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 p-1 rounded text-sm">
                            <input type="checkbox" value="Purple" class="color-checkbox rounded border-gray-300 text-primary focus:ring-primary focus:ring-2">
                            <span class="text-gray-700 dark:text-gray-300">Purple</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 p-1 rounded text-sm">
                            <input type="checkbox" value="Red" class="color-checkbox rounded border-gray-300 text-primary focus:ring-primary focus:ring-2">
                            <span class="text-gray-700 dark:text-gray-300">Red</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 p-1 rounded text-sm">
                            <input type="checkbox" value="Yellow" class="color-checkbox rounded border-gray-300 text-primary focus:ring-primary focus:ring-2">
                            <span class="text-gray-700 dark:text-gray-300">Yellow</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 p-1 rounded text-sm">
                            <input type="checkbox" value="Blue" class="color-checkbox rounded border-gray-300 text-primary focus:ring-primary focus:ring-2">
                            <span class="text-gray-700 dark:text-gray-300">Blue</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 p-1 rounded text-sm">
                            <input type="checkbox" value="Green" class="color-checkbox rounded border-gray-300 text-primary focus:ring-primary focus:ring-2">
                            <span class="text-gray-700 dark:text-gray-300">Green</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 p-1 rounded text-sm">
                            <input type="checkbox" value="Orange" class="color-checkbox rounded border-gray-300 text-primary focus:ring-primary focus:ring-2">
                            <span class="text-gray-700 dark:text-gray-300">Orange</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 p-1 rounded text-sm">
                            <input type="checkbox" value="White" class="color-checkbox rounded border-gray-300 text-primary focus:ring-primary focus:ring-2">
                            <span class="text-gray-700 dark:text-gray-300">White</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 p-1 rounded text-sm">
                            <input type="checkbox" value="Silver" class="color-checkbox rounded border-gray-300 text-primary focus:ring-primary focus:ring-2">
                            <span class="text-gray-700 dark:text-gray-300">Silver</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 p-1 rounded text-sm">
                            <input type="checkbox" value="Gold" class="color-checkbox rounded border-gray-300 text-primary focus:ring-primary focus:ring-2">
                            <span class="text-gray-700 dark:text-gray-300">Gold</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 p-1 rounded text-sm">
                            <input type="checkbox" value="Multi" class="color-checkbox rounded border-gray-300 text-primary focus:ring-primary focus:ring-2">
                            <span class="text-gray-700 dark:text-gray-300">Multi</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 p-1 rounded text-sm">
                            <input type="checkbox" value="Khaki" class="color-checkbox rounded border-gray-300 text-primary focus:ring-primary focus:ring-2">
                            <span class="text-gray-700 dark:text-gray-300">Khaki</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 p-1 rounded text-sm">
                            <input type="checkbox" value="Turquoise" class="color-checkbox rounded border-gray-300 text-primary focus:ring-primary focus:ring-2">
                            <span class="text-gray-700 dark:text-gray-300">Turquoise</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 p-1 rounded text-sm">
                            <input type="checkbox" value="Cream" class="color-checkbox rounded border-gray-300 text-primary focus:ring-primary focus:ring-2">
                            <span class="text-gray-700 dark:text-gray-300">Cream</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 p-1 rounded text-sm">
                            <input type="checkbox" value="Apricot" class="color-checkbox rounded border-gray-300 text-primary focus:ring-primary focus:ring-2">
                            <span class="text-gray-700 dark:text-gray-300">Apricot</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 p-1 rounded text-sm">
                            <input type="checkbox" value="Coral" class="color-checkbox rounded border-gray-300 text-primary focus:ring-primary focus:ring-2">
                            <span class="text-gray-700 dark:text-gray-300">Coral</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 p-1 rounded text-sm">
                            <input type="checkbox" value="Burgundy" class="color-checkbox rounded border-gray-300 text-primary focus:ring-primary focus:ring-2">
                            <span class="text-gray-700 dark:text-gray-300">Burgundy</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 p-1 rounded text-sm">
                            <input type="checkbox" value="Rose" class="color-checkbox rounded border-gray-300 text-primary focus:ring-primary focus:ring-2">
                            <span class="text-gray-700 dark:text-gray-300">Rose</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 p-1 rounded text-sm">
                            <input type="checkbox" value="Lilac" class="color-checkbox rounded border-gray-300 text-primary focus:ring-primary focus:ring-2">
                            <span class="text-gray-700 dark:text-gray-300">Lilac</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 p-1 rounded text-sm">
                            <input type="checkbox" value="Light blue" class="color-checkbox rounded border-gray-300 text-primary focus:ring-primary focus:ring-2">
                            <span class="text-gray-700 dark:text-gray-300">Light blue</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 p-1 rounded text-sm">
                            <input type="checkbox" value="Navy" class="color-checkbox rounded border-gray-300 text-primary focus:ring-primary focus:ring-2">
                            <span class="text-gray-700 dark:text-gray-300">Navy</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 p-1 rounded text-sm">
                            <input type="checkbox" value="Dark green" class="color-checkbox rounded border-gray-300 text-primary focus:ring-primary focus:ring-2">
                            <span class="text-gray-700 dark:text-gray-300">Dark green</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 p-1 rounded text-sm">
                            <input type="checkbox" value="Mustard" class="color-checkbox rounded border-gray-300 text-primary focus:ring-primary focus:ring-2">
                            <span class="text-gray-700 dark:text-gray-300">Mustard</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 p-1 rounded text-sm">
                            <input type="checkbox" value="Mint" class="color-checkbox rounded border-gray-300 text-primary focus:ring-primary focus:ring-2">
                            <span class="text-gray-700 dark:text-gray-300">Mint</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 p-1 rounded text-sm">
                            <input type="checkbox" value="Clear" class="color-checkbox rounded border-gray-300 text-primary focus:ring-primary focus:ring-2">
                            <span class="text-gray-700 dark:text-gray-300">Clear</span>
                        </label>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Pattern/Print</label>
                    <select id="pattern" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
                        <option value="">Solid color / No pattern</option>
                        <option value="Striped">Striped</option>
                        <option value="Checked">Checked</option>
                        <option value="Plaid">Plaid</option>
                        <option value="Floral">Floral</option>
                        <option value="Polka dot">Polka dot</option>
                        <option value="Animal print">Animal print</option>
                        <option value="Geometric">Geometric</option>
                        <option value="Abstract">Abstract</option>
                        <option value="Paisley">Paisley</option>
                        <option value="Houndstooth">Houndstooth</option>
                        <option value="Textured">Textured</option>
                    </select>
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Key Features (select all that apply)</label>
                <div id="features-grid" class="grid grid-cols-2 md:grid-cols-3 gap-2 p-3 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 max-h-48 overflow-y-auto">
                    <p class="col-span-full text-gray-500 dark:text-gray-400 text-sm italic">Select an item type to see feature options</p>
                </div>
                <div class="mt-2">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Other features (optional)</label>
                    <input type="text" id="custom-features" placeholder="Any additional features not listed above" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Measurements (if known)</label>
                <input type="text" id="measurements" placeholder="e.g., Chest 38cm, Length 60cm, Waist 32cm" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Fabric Texture</label>
                    <select id="fabric-texture" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
                        <option value="">Select texture...</option>
                        <option value="Soft">Soft</option>
                        <option value="Smooth">Smooth</option>
                        <option value="Stretchy">Stretchy</option>
                        <option value="Structured">Structured</option>
                        <option value="Crisp">Crisp</option>
                        <option value="Lightweight">Lightweight</option>
                        <option value="Heavy">Heavy</option>
                        <option value="Flowy">Flowy</option>
                        <option value="Drapey">Drapey</option>
                        <option value="Textured">Textured</option>
                        <option value="Ribbed">Ribbed</option>
                        <option value="Shiny">Shiny</option>
                        <option value="Matte">Matte</option>
                        <option value="Fuzzy">Fuzzy</option>
                        <option value="Cozy">Cozy</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Style Aesthetic</label>
                    <select id="style-aesthetic" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
                        <option value="">Select aesthetic...</option>
                        <option value="Minimalist">Minimalist</option>
                        <option value="Y2K">Y2K</option>
                        <option value="2000s">2000s</option>
                        <option value="Cottagecore">Cottagecore</option>
                        <option value="Dark Academia">Dark Academia</option>
                        <option value="Light Academia">Light Academia</option>
                        <option value="Boho">Boho</option>
                        <option value="Bohemian">Bohemian</option>
                        <option value="Vintage">Vintage</option>
                        <option value="Retro">Retro</option>
                        <option value="Grunge">Grunge</option>
                        <option value="Preppy">Preppy</option>
                        <option value="Streetwear">Streetwear</option>
                        <option value="Romantic">Romantic</option>
                        <option value="Feminine">Feminine</option>
                        <option value="Androgynous">Androgynous</option>
                        <option value="Tomboy">Tomboy</option>
                        <option value="Chic">Chic</option>
                        <option value="Parisian">Parisian</option>
                        <option value="Scandi">Scandi</option>
                        <option value="Scandinavian">Scandinavian</option>
                        <option value="Indie">Indie</option>
                        <option value="Alternative">Alternative</option>
                        <option value="Goth">Goth</option>
                        <option value="Emo">Emo</option>
                        <option value="Punk">Punk</option>
                        <option value="Rock">Rock</option>
                        <option value="Hipster">Hipster</option>
                        <option value="Artsy">Artsy</option>
                        <option value="Edgy">Edgy</option>
                        <option value="Soft Girl">Soft Girl</option>
                        <option value="VSCO Girl">VSCO Girl</option>
                        <option value="Clean Girl">Clean Girl</option>
                        <option value="That Girl">That Girl</option>
                        <option value="Old Money">Old Money</option>
                        <option value="Quiet Luxury">Quiet Luxury</option>
                        <option value="Coquette">Coquette</option>
                        <option value="Fairycore">Fairycore</option>
                        <option value="Goblincore">Goblincore</option>
                        <option value="Kidcore">Kidcore</option>
                        <option value="Kawaii">Kawaii</option>
                        <option value="Harajuku">Harajuku</option>
                        <option value="Korean Fashion">Korean Fashion</option>
                        <option value="Japanese Fashion">Japanese Fashion</option>
                        <option value="Workwear">Workwear</option>
                        <option value="Corporate">Corporate</option>
                        <option value="Business Casual">Business Casual</option>
                        <option value="Smart Casual">Smart Casual</option>
                        <option value="Casual">Casual</option>
                        <option value="Sporty">Sporty</option>
                        <option value="Athleisure">Athleisure</option>
                        <option value="Coastal">Coastal</option>
                        <option value="Grandpa">Grandpa</option>
                        <option value="Grandma">Grandma</option>
                    </select>
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Fit &amp; Length Notes</label>
                <input type="text" id="fit-notes" placeholder="e.g., Runs small, size up / True to size / Hits mid-thigh / Oversized as intended" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
            </div>



            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Best Season (select one if applicable)</label>
                <div class="grid grid-cols-2 gap-2 p-3 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700">
                    <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 p-1 rounded text-sm">
                        <input type="radio" name="season" value="Summer" class="rounded border-gray-300 text-primary focus:ring-primary focus:ring-2">
                        <span class="text-gray-700 dark:text-gray-300">Summer</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 p-1 rounded text-sm">
                        <input type="radio" name="season" value="Winter" class="rounded border-gray-300 text-primary focus:ring-primary focus:ring-2">
                        <span class="text-gray-700 dark:text-gray-300">Winter</span>
                    </label>
                </div>
            </div>



            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Flaws/Damage</label>
                <textarea id="flaws" placeholder="Describe any stains, holes, missing buttons, wear marks, etc. Be specific about location and size." rows="2" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white"></textarea>
            </div>

            <button id="generate-btn" class="w-full bg-primary hover:bg-primary-hover text-white px-6 py-3 rounded-md font-medium transition-colors">
                <span id="generate-text">Generate Listing</span>
                <span id="generate-loading" class="hidden">Generating...</span>
            </button>
        </div>

        <!-- Generated Content Section -->
        <div id="description-section" class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6 hidden">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">Your Fashion Listing</h2>
            
            <!-- Vinted Title -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Vinted Title:</label>
                <div class="bg-white dark:bg-gray-700 rounded-md p-4 border border-gray-200 dark:border-gray-600 mb-3">
                    <div id="generated-title" class="text-gray-900 dark:text-white font-medium"></div>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-3 mb-4">
                    <button id="copy-title-btn" class="flex-1 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md font-medium transition-colors">
                        📋 Copy Title
                    </button>
                    <button id="edit-title-btn" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md font-medium transition-colors">
                        ✏️ Edit Title
                    </button>
                </div>
            </div>

            <!-- Description -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Description:</label>
                <div class="bg-white dark:bg-gray-700 rounded-md p-4 border border-gray-200 dark:border-gray-600 mb-3">
                    <div id="generated-description" class="prose dark:prose-invert max-w-none overflow-wrap-anywhere break-words whitespace-pre-wrap"></div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col sm:flex-row gap-3 mb-6">
                <button id="copy-btn" class="flex-1 bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-md font-medium transition-colors">
                    📋 Copy Description
                </button>
                <button id="edit-btn" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-md font-medium transition-colors">
                    ✏️ Edit Description
                </button>
                <button id="new-btn" class="flex-1 bg-primary hover:bg-primary-hover text-white px-6 py-3 rounded-md font-medium transition-colors">
                    🆕 New Listing
                </button>
            </div>

            <!-- Save to Notion Section -->
            <div class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800">
                <h3 class="text-lg font-semibold text-blue-900 dark:text-blue-100 mb-3">💾 Save to Your Notion Inventory</h3>
                <p class="text-blue-700 dark:text-blue-300 text-sm mb-4">Automatically save all your item details and generated content to your "New stock table" database.</p>
                
                <div class="space-y-3">
                    <button id="test-notion-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-md font-medium transition-colors">
                        🔍 Test Notion Connection &amp; Database Structure
                    </button>
                    <button id="save-notion-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-md font-medium transition-colors">
                        <span id="save-notion-text">💾 Save to Notion Database</span>
                        <span id="save-notion-loading" class="hidden">Saving to Notion...</span>
                    </button>
                    <button id="generate-curl-btn" class="w-full bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-md font-medium transition-colors">
                        📋 Generate Curl Command (Manual Backup)
                    </button>
                    <button id="copy-data-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-md font-medium transition-colors">
                        📄 Copy Formatted Data (Manual Entry)
                    </button>
                </div>
            </div>
        </div>



        <!-- Edit Modal -->
        <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Edit Description</h3>
                <textarea id="edit-text" rows="12" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white"></textarea>
                <div class="flex justify-end space-x-3 mt-4">
                    <button id="cancel-btn" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">Cancel</button>
                    <button id="save-btn" class="px-4 py-2 bg-primary text-white hover:bg-primary-hover rounded">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentDescription = '';

        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('generate-btn').addEventListener('click', generateDescription);
            document.getElementById('copy-btn').addEventListener('click', copyDescription);
            document.getElementById('edit-btn').addEventListener('click', showEditModal);
            document.getElementById('new-btn').addEventListener('click', startNew);
            document.getElementById('cancel-btn').addEventListener('click', hideEditModal);
            document.getElementById('save-btn').addEventListener('click', saveEdit);
            
            // Title editing (copy and edit buttons are created after generation)
            document.getElementById('copy-title-btn').addEventListener('click', copyTitle);
            document.getElementById('edit-title-btn').addEventListener('click', editTitle);
            
            // Notion integration
            document.getElementById('test-notion-btn').addEventListener('click', testNotionConnection);
            document.getElementById('save-notion-btn').addEventListener('click', saveToNotion);
            document.getElementById('generate-curl-btn').addEventListener('click', generateCurlCommand);
            document.getElementById('copy-data-btn').addEventListener('click', copyFormattedData);
            
            // Dynamic fit and length options based on item type
            document.getElementById('item-type').addEventListener('change', updateFitOptions);
            document.getElementById('item-type').addEventListener('change', updateLengthOptions);
            document.getElementById('item-type').addEventListener('change', updateFeaturesPlaceholder);
            
            // Color selection limit functionality
            setupColorSelectionLimit();
            
            // API key management
            setupApiKeyManagement();
        }

        function updateFitOptions() {
            const itemType = document.getElementById('item-type').value.toLowerCase();
            const fitSelect = document.getElementById('fit');
            
            // Clear current options
            fitSelect.innerHTML = '<option value="">Select fit...</option>';
            
            let options = [];
            
            if (itemType.includes('dress')) {
                options = ['Bodycon', 'A-line', 'Fit and flare', 'Shift', 'Wrap', 'Slip', 'Oversized', 'Fitted', 'Empire waist', 'Babydoll'];
            } else if (itemType.includes('skirt')) {
                options = ['A-line', 'Pencil', 'High waisted', 'Low waisted', 'Pleated', 'Wrap', 'Circle skirt', 'Straight', 'Bias cut'];
            } else if (itemType.includes('pants') || itemType.includes('trousers') || itemType.includes('jeans')) {
                options = ['High waisted', 'Low waisted', 'Wide leg', 'Straight leg', 'Slim fit', 'Skinny', 'Bootcut', 'Flare', 'Relaxed', 'Mom fit', 'Boyfriend fit'];
            } else if (itemType.includes('jacket') || itemType.includes('blazer') || itemType.includes('coat')) {
                options = ['Oversized', 'Fitted', 'Tailored', 'Relaxed', 'Double breasted', 'Single breasted', 'Boxy', 'Structured'];
            } else if (itemType.includes('top') || itemType.includes('blouse') || itemType.includes('shirt')) {
                options = ['Oversized', 'Fitted', 'Relaxed', 'Slim fit', 'Boxy', 'Flowy', 'Peplum', 'Wrap style', 'Tunic'];
            } else if (itemType.includes('sweater') || itemType.includes('cardigan')) {
                options = ['Oversized', 'Fitted', 'Relaxed', 'Chunky knit', 'Fine knit', 'Boxy', 'Cable knit'];
            } else if (itemType.includes('shorts')) {
                options = ['High waisted', 'Low waisted', 'Relaxed', 'Fitted', 'Wide leg', 'Straight', 'Bermuda'];
            } else {
                // Default options for accessories and other items
                options = ['Oversized', 'Regular fit', 'Fitted', 'Adjustable', 'One size'];
            }
            
            // Add options to select
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                fitSelect.appendChild(optionElement);
            });
        }

        function updateLengthOptions() {
            const itemType = document.getElementById('item-type').value.toLowerCase();
            const lengthSelect = document.getElementById('length');
            
            // Clear current options
            lengthSelect.innerHTML = '<option value="">Select length...</option>';
            
            let options = [];
            
            if (itemType.includes('dress')) {
                options = ['Mini length', 'Above knee', 'Knee length', 'Midi length', 'Maxi length', 'Floor length', 'Tea length', 'Asymmetrical hem'];
            } else if (itemType.includes('skirt')) {
                options = ['Mini length', 'Above knee', 'Knee length', 'Midi length', 'Maxi length', 'Floor length', 'Tea length'];
            } else if (itemType.includes('pants') || itemType.includes('trousers') || itemType.includes('jeans')) {
                options = ['Full length', 'Ankle length', '7/8 length', 'Cropped', 'Capri length', '3/4 length'];
            } else if (itemType.includes('shorts')) {
                options = ['Mini shorts', 'Short length', 'Mid-thigh', 'Bermuda length', 'Knee length'];
            } else if (itemType.includes('jacket') || itemType.includes('blazer') || itemType.includes('coat')) {
                options = ['Cropped', 'Hip length', 'Regular length', 'Long length', 'Knee length', 'Midi length', 'Maxi length'];
            } else if (itemType.includes('top') || itemType.includes('blouse') || itemType.includes('shirt')) {
                options = ['Cropped', 'Regular length', 'Hip length', 'Tunic length', 'Long length'];
            } else if (itemType.includes('sweater') || itemType.includes('cardigan')) {
                options = ['Cropped', 'Regular length', 'Hip length', 'Long length', 'Tunic length', 'Duster length'];
            } else if (itemType.includes('tank') || itemType.includes('camisole')) {
                options = ['Cropped', 'Regular length', 'Hip length', 'Tunic length'];
            } else if (itemType.includes('scarf')) {
                options = ['Short', 'Regular length', 'Long', 'Extra long', 'Infinity style'];
            } else if (itemType.includes('necklace')) {
                options = ['Choker', 'Short', 'Princess', 'Matinee', 'Opera', 'Rope length'];
            } else if (itemType.includes('bracelet')) {
                options = ['Short', 'Standard', 'Long', 'Wrap around'];
            } else if (itemType.includes('earrings')) {
                options = ['Stud', 'Short drop', 'Medium drop', 'Long drop', 'Statement length'];
            } else if (itemType.includes('boots')) {
                options = ['Ankle boots', 'Mid-calf', 'Knee high', 'Over knee', 'Thigh high'];
            } else if (itemType.includes('heels') || itemType.includes('pumps')) {
                options = ['Low heel', 'Mid heel', 'High heel', 'Very high heel'];
            } else {
                // Default options for other accessories
                options = ['Standard size', 'Compact', 'Large', 'Mini', 'Regular'];
            }
            
            // Add options to select
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                lengthSelect.appendChild(optionElement);
            });
        }

        function updateFeaturesPlaceholder() {
            const itemType = document.getElementById('item-type').value.toLowerCase();
            const featuresGrid = document.getElementById('features-grid');
            
            // Clear existing checkboxes
            featuresGrid.innerHTML = '';
            
            let features = [];
            
            if (itemType.includes('dress')) {
                features = [
                    // Sleeves
                    'Sleeveless', 'Short sleeves', 'Long sleeves', 'Three-quarter sleeves', 'Cap sleeves', 'Bell sleeves', 'Bishop sleeves', 'Puff sleeves',
                    // Necklines
                    'V-neck', 'Round neck', 'Scoop neck', 'High neck', 'Off-shoulder', 'One shoulder', 'Halter neck', 'Square neck', 'Boat neck', 'Cowl neck',
                    // Closures & Details
                    'Zip back', 'Button front', 'Button back', 'Wrap style', 'Tie waist', 'Belt included', 'Drawstring waist', 'Smocked waist', 'Elastic waist',
                    // Construction
                    'Lined', 'Unlined', 'Built-in bra', 'Padded bra', 'Underwire', 'Adjustable straps',
                    // Pockets & Features
                    'Side pockets', 'Hidden pockets', 'No pockets', 'Tiered', 'Pleated', 'Gathered', 'Ruched', 'Shirred',
                    // Length & Fit
                    'Mini length', 'Above knee', 'Knee length', 'Midi length', 'Maxi length', 'Floor length', 'Side slits', 'Front slit', 'Back slit', 'High-low hem'
                ];
            } else if (itemType.includes('skirt')) {
                features = [
                    // Closures
                    'Side zip', 'Back zip', 'Front zip', 'Button front', 'Elastic waist', 'Pull-on style', 'Tie waist', 'Belt loops',
                    // Waist styles
                    'High waisted', 'Low waisted', 'Mid rise', 'Drop waist',
                    // Construction
                    'Lined', 'Unlined', 'Built-in shorts', 'Stretch waistband',
                    // Pockets
                    'Side pockets', 'Back pockets', 'Hidden pockets', 'No pockets',
                    // Styles & Details
                    'A-line', 'Pencil', 'Circle skirt', 'Pleated', 'Wrap style', 'Tiered', 'Asymmetrical', 'Bias cut',
                    // Length & Features
                    'Mini length', 'Above knee', 'Knee length', 'Midi length', 'Maxi length', 'Side slits', 'Front slit', 'Back slit', 'Ruffled hem', 'Raw hem'
                ];
            } else if (itemType.includes('pants') || itemType.includes('trousers') || itemType.includes('jeans')) {
                features = [
                    // Waist & Rise
                    'High waisted', 'Low waisted', 'Mid rise', 'Ultra high rise', 'Belt loops', 'No belt loops', 'Elastic waist', 'Drawstring waist',
                    // Pockets
                    'Front pockets', 'Back pockets', 'Side pockets', 'Cargo pockets', 'Coin pocket', 'No back pockets',
                    // Closures
                    'Zip fly', 'Button fly', 'Button closure', 'Pull-on style',
                    // Leg Styles
                    'Wide leg', 'Straight leg', 'Skinny', 'Slim fit', 'Bootcut', 'Flare', 'Boyfriend fit', 'Mom fit', 'Relaxed fit',
                    // Length & Hems
                    'Full length', 'Cropped', 'Ankle length', '7/8 length', 'Capri length', 'Cuffed', 'Raw hem', 'Turned up hem',
                    // Denim specific
                    'Distressed', 'Ripped', 'Holes', 'Faded', 'Stone washed', 'Dark wash', 'Light wash', 'Vintage wash', 'Stretch denim', 'Rigid denim'
                ];
            } else if (itemType.includes('jacket') || itemType.includes('blazer') || itemType.includes('coat')) {
                features = [
                    // Construction
                    'Lined', 'Unlined', 'Partially lined', 'Padded', 'Insulated', 'Windproof', 'Water resistant',
                    // Closures
                    'Zip closure', 'Button front', 'Double breasted', 'Single breasted', 'Snap buttons', 'Hook and eye', 'Open front',
                    // Collar & Necklines
                    'Lapels', 'Notch lapels', 'Peak lapels', 'Shawl lapels', 'No lapels', 'Stand collar', 'Hood', 'Removable hood', 'Faux fur hood',
                    // Pockets
                    'Side pockets', 'Chest pockets', 'Inner pockets', 'Flap pockets', 'Welt pockets', 'Patch pockets', 'No pockets',
                    // Fit & Style
                    'Cropped', 'Long length', 'Regular length', 'Oversized', 'Fitted', 'Boxy', 'Tailored', 'Relaxed fit',
                    // Details
                    'Shoulder pads', 'Belt', 'Removable belt', 'Adjustable cuffs', 'Vent back', 'No vent', 'Epaulettes', 'Contrast lining'
                ];
            } else if (itemType.includes('top') || itemType.includes('blouse') || itemType.includes('shirt')) {
                features = [
                    // Sleeves
                    'Short sleeves', 'Long sleeves', 'Sleeveless', 'Three-quarter sleeves', 'Cap sleeves', 'Bell sleeves', 'Puff sleeves', 'Rolled sleeves',
                    // Necklines
                    'V-neck', 'Round neck', 'Scoop neck', 'High neck', 'Boat neck', 'Square neck', 'Halter', 'Off-shoulder', 'Cold shoulder',
                    // Collar styles
                    'Collar', 'No collar', 'Button-down collar', 'Stand collar', 'Peter Pan collar', 'Bow tie collar',
                    // Closures & Style
                    'Button front', 'Button back', 'Pullover', 'Wrap style', 'Tie front', 'Tie back', 'Zip back', 'Keyhole back',
                    // Fit & Length
                    'Cropped', 'Regular length', 'Tunic length', 'Loose fit', 'Fitted', 'Oversized', 'Boxy', 'Peplum', 'Asymmetrical',
                    // Details & Features
                    'Chest pocket', 'Side slits', 'Ruffles', 'Pleated', 'Tucked front', 'Embroidered', 'Lace trim', 'Contrast collar', 'French cuffs'
                ];
            } else if (itemType.includes('sweater') || itemType.includes('cardigan')) {
                features = [
                    // Knit Types
                    'Cable knit', 'Ribbed', 'Chunky knit', 'Fine knit', 'Aran knit', 'Fair Isle', 'Intarsia', 'Waffle knit', 'Fisherman knit',
                    // Necklines
                    'Crew neck', 'V-neck', 'Turtleneck', 'Mock neck', 'Cowl neck', 'Boat neck', 'Scoop neck',
                    // Closures (Cardigans)
                    'Button front', 'Zip front', 'Open front', 'Tie front', 'Hook and eye', 'Snap buttons',
                    // Style & Fit
                    'Pullover', 'Oversized', 'Fitted', 'Cropped', 'Long length', 'Tunic length', 'Boxy', 'Relaxed fit',
                    // Sleeves
                    'Long sleeves', 'Short sleeves', 'Three-quarter sleeves', 'Sleeveless', 'Dolman sleeves', 'Raglan sleeves',
                    // Details
                    'Pockets', 'No pockets', 'Hood', 'Ribbed cuffs', 'Ribbed hem', 'Side slits', 'High-low hem', 'Contrast trim', 'Textured pattern'
                ];
            } else if (itemType.includes('tank') || itemType.includes('camisole')) {
                features = [
                    // Styles
                    'Spaghetti straps', 'Wide straps', 'Racerback', 'Straight back', 'Cross back', 'Halter style',
                    // Necklines
                    'Scoop neck', 'V-neck', 'Round neck', 'Square neck', 'High neck', 'Sweetheart',
                    // Fit & Length
                    'Fitted', 'Loose fit', 'Cropped', 'Regular length', 'Tunic length', 'Bodysuit style',
                    // Construction
                    'Built-in bra', 'Shelf bra', 'Padded', 'No bra support', 'Lined', 'Unlined', 'Adjustable straps',
                    // Details
                    'Lace trim', 'Ruched', 'Shirred', 'Pleated', 'Side slits', 'Raw edges', 'Contrast binding'
                ];
            } else {
                features = [
                    'Button front', 'Zip closure', 'Pullover style', 'Wrap style', 'Tie closure',
                    'Pockets', 'No pockets', 'Side pockets', 'Chest pocket',
                    'Long sleeves', 'Short sleeves', 'Sleeveless', 'Three-quarter sleeves',
                    'Lined', 'Unlined', 'Padded', 'Stretch fabric',
                    'V-neck', 'Round neck', 'High neck', 'Collar', 'No collar',
                    'Cropped', 'Regular length', 'Long length', 'Oversized', 'Fitted',
                    'Vintage buttons', 'Side slits', 'Adjustable', 'Elastic waist',
                    'Pleated', 'Gathered', 'Embroidered', 'Contrast details'
                ];
            }
            
            if (features.length === 0) {
                featuresGrid.innerHTML = '<p class="col-span-full text-gray-500 dark:text-gray-400 text-sm italic">Select an item type to see feature options</p>';
                return;
            }
            
            // Create checkboxes for each feature
            features.forEach(feature => {
                const label = document.createElement('label');
                label.className = 'flex items-center space-x-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600 p-1 rounded text-sm';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = feature;
                checkbox.className = 'rounded border-gray-300 text-primary focus:ring-primary focus:ring-2';
                
                const span = document.createElement('span');
                span.textContent = feature;
                span.className = 'text-gray-700 dark:text-gray-300';
                
                label.appendChild(checkbox);
                label.appendChild(span);
                featuresGrid.appendChild(label);
            });
        }

        async function generateDescription() {
            // Validate required fields
            const itemType = document.getElementById('item-type').value;
            const size = document.getElementById('size').value;
            const material1 = document.getElementById('material1').value;
            const condition = document.getElementById('condition').value;
            const selectedColors = getSelectedColors();

            if (!itemType || !size || !material1 || !condition || !selectedColors) {
                showAlert('Please fill in all required fields (marked with *)');
                return;
            }

            const generateBtn = document.getElementById('generate-btn');
            const generateText = document.getElementById('generate-text');
            const generateLoading = document.getElementById('generate-loading');
            
            generateBtn.disabled = true;
            generateText.classList.add('hidden');
            generateLoading.classList.remove('hidden');

            try {
                // Collect all form data
                const brand = document.getElementById('brand').value;
                const era = document.getElementById('era').value;
                const color = getSelectedColors();
                const pattern = document.getElementById('pattern').value;
                const fit = document.getElementById('fit').value;
                const length = document.getElementById('length').value;
                const measurements = document.getElementById('measurements').value;
                const flaws = document.getElementById('flaws').value;
                const material2 = document.getElementById('material2').value;
                const customFeatures = document.getElementById('custom-features').value;
                const fabricTexture = document.getElementById('fabric-texture').value;
                const styleAesthetic = document.getElementById('style-aesthetic').value;
                const fitNotes = document.getElementById('fit-notes').value;

                // Collect selected features from checkboxes
                const selectedFeatures = [];
                const checkboxes = document.querySelectorAll('#features-grid input[type="checkbox"]:checked');
                checkboxes.forEach(checkbox => {
                    selectedFeatures.push(checkbox.value);
                });
                
                // Combine selected features with custom features
                let allFeatures = selectedFeatures.join(', ');
                if (customFeatures) {
                    allFeatures += allFeatures ? `, ${customFeatures}` : customFeatures;
                }

                // Collect selected season (radio button)
                const selectedSeason = document.querySelector('input[name="season"]:checked');
                const season = selectedSeason ? selectedSeason.value : '';

                // Build material string
                let materialString = material1;
                if (material2) {
                    materialString += `/${material2}`;
                }

                // Determine if we should show era
                const showEra = era && era !== 'Unspecified Vintage';

                // Generate hashtags using our smart system
                const generatedHashtags = generateSmartHashtags({
                    itemType, brand, color, pattern, material1, era, styleAesthetic, 
                    fabricTexture, fit, season
                });

                // Create structured listing format prompt
                const prompt = `Create structured Vinted listing. NO intro text. Start immediately with:

Brand: ${brand || 'Unbranded'}
Size: ${size}
Material: ${materialString}
Colour: ${color}
${showEra ? `Era: ${era}` : ''}
${fit ? `Fit: ${fit}` : ''}
${length ? `Length: ${length}` : ''}
${fabricTexture ? `Feel: ${fabricTexture}` : ''}
${allFeatures ? `Features: ${allFeatures}` : ''}
${season ? `Season: ${season}` : ''}
Condition: ${condition}

${flaws ? `Please note: ${flaws}` : ''}

Washed and steamed, ships within 2 working days.

${generatedHashtags}`;

                // Call OpenAI API
                const response = await callOpenAI(prompt);
                displayDescription(response);
                resetButton();

            } catch (error) {
                console.error('Generation error:', error);
                showAlert('Generation failed. Please try again.');
                resetButton();
            }
        }

        function resetButton() {
            const generateBtn = document.getElementById('generate-btn');
            const generateText = document.getElementById('generate-text');
            const generateLoading = document.getElementById('generate-loading');
            
            generateBtn.disabled = false;
            generateText.classList.remove('hidden');
            generateLoading.classList.add('hidden');
        }

        function displayDescription(description) {
            currentDescription = description;
            document.getElementById('generated-description').innerHTML = marked.parse(description);
            document.getElementById('description-section').classList.remove('hidden');
            
            // Automatically generate title after description is ready
            generateTitle();
            
            document.getElementById('description-section').scrollIntoView({ behavior: 'smooth' });
        }

        async function copyDescription() {
            try {
                const element = document.getElementById('generated-description');
                const text = element.textContent || element.innerText;
                await navigator.clipboard.writeText(text);
                
                const btn = document.getElementById('copy-btn');
                const original = btn.textContent;
                btn.textContent = '✅ Copied!';
                setTimeout(() => btn.textContent = original, 2000);
            } catch (error) {
                showAlert('Copy failed. Please copy manually.');
            }
        }

        function showEditModal() {
            document.getElementById('edit-text').value = currentDescription;
            document.getElementById('edit-modal').classList.remove('hidden');
        }

        function hideEditModal() {
            document.getElementById('edit-modal').classList.add('hidden');
        }

        function saveEdit() {
            currentDescription = document.getElementById('edit-text').value;
            displayDescription(currentDescription);
            hideEditModal();
        }

        function startNew() {
            document.querySelectorAll('input, select, textarea').forEach(el => el.value = '');
            document.getElementById('description-section').classList.add('hidden');
            currentDescription = '';
            
            // Clear the title text
            document.getElementById('generated-title').textContent = '';
            
            // Clear any checked checkboxes and radio buttons
            document.querySelectorAll('input[type="checkbox"]').forEach(el => el.checked = false);
            document.querySelectorAll('input[type="radio"]').forEach(el => el.checked = false);
            
            // Reset features grid
            updateFeaturesPlaceholder();
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ============ OPENAI API INTEGRATION ============

        let sessionApiKey = null; // Store in memory for this session

        function getApiKey() {
            if (sessionApiKey) {
                return sessionApiKey;
            }

            // Try localStorage first, fallback to session storage if blocked
            try {
                sessionApiKey = localStorage.getItem('openai_api_key');
            } catch (e) {
                try {
                    sessionApiKey = sessionStorage.getItem('openai_api_key');
                } catch (e2) {
                    // Both storage methods blocked, use memory only
                }
            }

            if (!sessionApiKey) {
                sessionApiKey = prompt('Enter your OpenAI API Key (starts with sk-):');
                if (!sessionApiKey || !sessionApiKey.startsWith('sk-')) {
                    throw new Error('Invalid API key format');
                }
                
                // Try to save for future use
                try {
                    localStorage.setItem('openai_api_key', sessionApiKey);
                } catch (e) {
                    try {
                        sessionStorage.setItem('openai_api_key', sessionApiKey);
                    } catch (e2) {
                        // Storage blocked, just keep in memory
                        console.log('Storage blocked, API key will only persist for this session');
                    }
                }
            }
            return sessionApiKey;
        }

        async function callOpenAI(prompt) {
            try {
                const apiKey = getApiKey();
                console.log('Using API key:', apiKey?.substring(0, 7) + '...');
                
                const requestBody = {
                    model: 'gpt-4o-mini',
                    messages: [
                        {
                            role: 'user',
                            content: prompt
                        }
                    ],
                    max_tokens: 1000,
                    temperature: 0.7
                };

                console.log('Making OpenAI request...');
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                console.log('Response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('OpenAI API error response:', errorText);
                    
                    let errorMessage = `OpenAI API error (${response.status})`;
                    
                    try {
                        const errorData = JSON.parse(errorText);
                        if (errorData.error && errorData.error.message) {
                            errorMessage = errorData.error.message;
                        }
                    } catch (e) {
                        // If we can't parse the error, use the text
                        errorMessage = errorText || errorMessage;
                    }
                    
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                console.log('OpenAI response received successfully');
                
                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    throw new Error('Invalid response format from OpenAI API');
                }
                
                return data.choices[0].message.content.trim();
                
            } catch (error) {
                console.error('OpenAI API call failed:', error);
                
                // Provide more helpful error messages
                if (error.message.includes('401')) {
                    throw new Error('Invalid API key. Please check your OpenAI API key.');
                } else if (error.message.includes('429')) {
                    throw new Error('API quota exceeded. Please check your OpenAI usage limits.');
                } else if (error.message.includes('CORS')) {
                    throw new Error('Network error. Try refreshing the page.');
                } else if (error.message.includes('fetch')) {
                    throw new Error('Network error. Check your internet connection.');
                } else {
                    throw error; // Re-throw the original error
                }
            }
        }

        // ============ TITLE GENERATION FUNCTIONS ============

        async function generateTitle() {
            // Validate required fields
            const itemType = document.getElementById('item-type').value;
            const size = document.getElementById('size').value;
            const material1 = document.getElementById('material1').value;
            const condition = document.getElementById('condition').value;
            const color = getSelectedColors();

            if (!itemType || !size || !material1 || !condition || !color) {
                return; // Silently fail if called automatically and fields aren't filled
            }

            try {
                // Collect key form data for title
                const brand = document.getElementById('brand').value;
                const era = document.getElementById('era').value;
                const pattern = document.getElementById('pattern').value;
                const fit = document.getElementById('fit').value;
                const length = document.getElementById('length').value;
                const styleAesthetic = document.getElementById('style-aesthetic').value;

                // Build comprehensive prompt for title generation
                let titlePrompt = `Generate a concise, searchable Vinted title (40-60 characters) for this item. Include key search terms buyers use.

Item: ${itemType}`;

                if (brand && brand.toLowerCase() !== 'unbranded' && brand.toLowerCase() !== 'no brand') {
                    titlePrompt += `\nBrand: ${brand}`;
                }

                titlePrompt += `\nSize: ${size}`;
                titlePrompt += `\nColor: ${color}`;

                if (pattern) {
                    titlePrompt += `\nPattern: ${pattern}`;
                }

                if (era && era !== 'Unspecified Vintage' && era !== '2020s') {
                    titlePrompt += `\nEra: ${era}`;
                }

                if (fit) {
                    titlePrompt += `\nFit: ${fit}`;
                }

                if (length) {
                    titlePrompt += `\nLength: ${length}`;
                }

                if (styleAesthetic) {
                    titlePrompt += `\nStyle: ${styleAesthetic}`;
                }

                titlePrompt += `\nCondition: ${condition}`;

                titlePrompt += `\n\nCreate a title that:
- Starts with brand (if known/popular) or era (if vintage)  
- Includes item type and key descriptors
- Uses Vinted buyer search terms
- Is 40-60 characters max
- Avoids unnecessary words

Examples:
"Zara Black Midi Dress Size M Elegant"
"90s Vintage Mom Jeans High Waisted Size 10"
"COS Oversized Wool Coat Size L Minimalist"

Generate ONLY the title, no explanation.`;

                // Call OpenAI API
                const titleResponse = await callOpenAI(titlePrompt);
                displayTitle(titleResponse);

            } catch (error) {
                console.error('Title generation error:', error);
                showAlert('Title generation failed. Please try again.');
            }
        }

        function resetTitleButton() {
            const generateBtn = document.getElementById('generate-title-btn');
            const generateText = document.getElementById('generate-title-text');
            const generateLoading = document.getElementById('generate-title-loading');
            
            generateBtn.disabled = false;
            generateText.classList.remove('hidden');
            generateLoading.classList.add('hidden');
        }

        function displayTitle(title) {
            // Clean up the title (remove quotes, extra spaces, etc.)
            const cleanTitle = title.replace(/['"]/g, '').trim();
            
            document.getElementById('generated-title').textContent = cleanTitle;
        }

        async function copyTitle() {
            try {
                const titleText = document.getElementById('generated-title').textContent;
                await navigator.clipboard.writeText(titleText);
                
                const btn = document.getElementById('copy-title-btn');
                const original = btn.textContent;
                btn.textContent = '✅ Copied!';
                setTimeout(() => btn.textContent = original, 2000);
            } catch (error) {
                showAlert('Copy failed. Please copy manually.');
            }
        }

        function editTitle() {
            const titleDiv = document.getElementById('generated-title');
            const currentTitle = titleDiv.textContent;
            
            // Create input field for editing
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentTitle;
            input.className = 'w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white';
            input.maxLength = 80;
            
            // Replace title with input
            titleDiv.innerHTML = '';
            titleDiv.appendChild(input);
            input.focus();
            input.select();
            
            // Handle save on Enter or blur
            function saveTitle() {
                const newTitle = input.value.trim();
                titleDiv.textContent = newTitle || currentTitle;
            }
            
            input.addEventListener('blur', saveTitle);
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    input.blur();
                }
            });
        }

        // ============ NOTION INTEGRATION FUNCTIONS ============

        async function testNotionConnection() {
            const databaseId = '232a1f71-892c-808a-9013-cb1f0901e834';
            const apiToken = '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';

            window.Poe.registerHandler("notion-tester", (result) => {
                const msg = result.responses[0];
                console.log('Notion Test Response:', msg);
                
                if (msg.status === "complete") {
                    showAlert(`Database Test: ${msg.content.substring(0, 800)}...`);
                } else if (msg.status === "error") {
                    showAlert(`Test Error: ${msg.statusText || 'Unknown error'}`);
                }
            });

            const testPrompt = `@Claude-Sonnet-4 Test my Notion database connection and show me the structure.

DATABASE ID: ${databaseId}
API TOKEN: ${apiToken}

Make a GET request to: https://api.notion.com/v1/databases/${databaseId}

Headers:
- Authorization: Bearer ${apiToken}
- Notion-Version: 2022-06-28

This will show me:
1. If the connection works
2. All property names in the database
3. Property types (rich_text, select, date, etc.)
4. Available select options if any

Show me the EXACT property names so I can map them correctly.`;

            try {
                await window.Poe.sendUserMessage(testPrompt, {
                    handler: "notion-tester",
                    stream: false,
                    openChat: false
                });
            } catch (error) {
                showAlert('Failed to test Notion connection.');
            }
        }

        async function saveToNotion() {
            // Validate that we have title and description generated
            const generatedTitle = document.getElementById('generated-title').textContent;
            const descriptionSectionVisible = !document.getElementById('description-section').classList.contains('hidden');
            
            if (!currentDescription || !generatedTitle || !descriptionSectionVisible) {
                showAlert('Please generate the listing first before saving to Notion.');
                return;
            }

            // Use hardcoded Notion credentials
            const databaseId = '232a1f71-892c-808a-9013-cb1f0901e834';
            const apiToken = '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';

            const saveBtn = document.getElementById('save-notion-btn');
            const saveText = document.getElementById('save-notion-text');
            const saveLoading = document.getElementById('save-notion-loading');
            
            saveBtn.disabled = true;
            saveText.classList.add('hidden');
            saveLoading.classList.remove('hidden');

            try {
                // Collect all form data
                const formData = collectAllFormData();
                
                // Collect selected features
                const selectedFeatures = [];
                const checkboxes = document.querySelectorAll('#features-grid input[type="checkbox"]:checked');
                checkboxes.forEach(checkbox => {
                    selectedFeatures.push(checkbox.value);
                });

                // Get season
                const selectedSeason = document.querySelector('input[name="season"]:checked');
                const season = selectedSeason ? selectedSeason.value : '';

                window.Poe.registerHandler("notion-saver", (result) => {
                    const msg = result.responses[0];
                    console.log('Notion API Response:', msg);
                    
                    if (msg.status === "complete") {
                        // Show the full response for debugging
                        showAlert(`Response: ${msg.content.substring(0, 500)}...`);
                        
                        if (msg.content.includes('success') || msg.content.includes('created') || msg.content.includes('added')) {
                            showSuccessAlert('✅ Successfully saved to Notion database!');
                        }
                    } else if (msg.status === "error") {
                        showAlert(`Error: ${msg.statusText || 'Unknown error'}`);
                    }
                    resetNotionButton();
                });

                // Build comprehensive data package for Notion
                const notionData = {
                    title: generatedTitle,
                    description: currentDescription.replace(/\n/g, '\\n'),
                    ...formData,
                    features: selectedFeatures.join(', '),
                    season: season,
                    dateCreated: new Date().toISOString().split('T')[0] // YYYY-MM-DD format
                };

                // Map item type to category
                const itemTypeMapping = {
                    'dress': 'Dresses',
                    'midi dress': 'Dresses', 
                    'maxi dress': 'Dresses',
                    'mini dress': 'Dresses',
                    'party dress': 'Dresses',
                    'wedding dress': 'Dresses',
                    'cocktail dress': 'Dresses',
                    'skirt': 'Skirts',
                    'midi skirt': 'Skirts',
                    'mini skirt': 'Skirts',
                    'a-line skirt': 'Skirts',
                    'pleated skirt': 'Skirts',
                    'jeans': 'Jeans',
                    'vintage jeans': 'Jeans',
                    'mom jeans': 'Jeans',
                    'skinny jeans': 'Jeans',
                    'trousers': 'Trousers',
                    'pants': 'Trousers',
                    'wide leg pants': 'Trousers',
                    'high waisted pants': 'Trousers',
                    'shorts': 'Shorts',
                    'denim shorts': 'Shorts',
                    'blazer': 'Blazers',
                    'vintage blazer': 'Blazers',
                    'shirt': 'Shirts and Blouses',
                    'blouse': 'Shirts and Blouses',
                    'vintage blouse': 'Shirts and Blouses',
                    'button-up shirt': 'Shirts and Blouses',
                    'top': 'Tops',
                    'tank top': 'Tops',
                    'camisole': 'Tops',
                    'crop top': 'Tops',
                    't-shirt': 'Tops',
                    'sweater': 'Knitwear',
                    'vintage sweater': 'Knitwear',
                    'cardigan': 'Knitwear',
                    'jacket': 'Coats and Jackets',
                    'leather jacket': 'Coats and Jackets',
                    'denim jacket': 'Coats and Jackets',
                    'bomber jacket': 'Coats and Jackets',
                    'coat': 'Coats and Jackets',
                    'trench coat': 'Coats and Jackets',
                    'puffer jacket': 'Coats and Jackets',
                    'vest': 'Waistcoats',
                    'suit': 'Suits',
                    'vintage suit': 'Suits',
                    'two piece set': 'Suits',
                    'heels': 'Shoes',
                    'boots': 'Shoes',
                    'sneakers': 'Shoes',
                    'flats': 'Shoes'
                };

                // Map condition values
                const conditionMapping = {
                    'BNWT': 'Brand new with tags',
                    'NWOT': 'Brand new without tags', 
                    'Very good': 'Very good',
                    'Good': 'Good',
                    'Satisfactory': 'Satisfactory'
                };

                const mappedCategory = itemTypeMapping[formData.itemType.toLowerCase()] || 'Tops';
                const mappedCondition = conditionMapping[formData.condition] || 'Good';

                // Create a better Notion API prompt with correct mapping
                const notionPrompt = `@Claude-Sonnet-4 Make a real HTTP POST request to the Notion API to add this item.

CREDENTIALS:
Database ID: ${databaseId}
API Token: ${apiToken}

REQUEST: POST https://api.notion.com/v1/pages
Headers:
- Authorization: Bearer ${apiToken}
- Content-Type: application/json
- Notion-Version: 2022-06-28

Body (use EXACTLY these property names and structure):
{
  "parent": { "database_id": "${databaseId}" },
  "properties": {
    "Item": {
      "title": [
        {
          "text": {
            "content": "${notionData.title}"
          }
        }
      ]
    },
    "Brand": {
      "rich_text": [
        {
          "text": {
            "content": "${formData.brand || 'Unbranded'}"
          }
        }
      ]
    },
    "Size": {
      "multi_select": [
        {
          "name": "${formData.size}"
        }
      ]
    },
    "Category": {
      "select": {
        "name": "${mappedCategory}"
      }
    },
    "Colour": {
      "multi_select": [
        {
          "name": "${formData.color}"
        }
      ]
    },
    "Material": {
      "multi_select": [
        {
          "name": "${formData.material1}"
        }
      ]
    },
    "Condition": {
      "select": {
        "name": "${mappedCondition}"
      }
    },
    "Description": {
      "rich_text": [
        {
          "text": {
            "content": "${currentDescription.substring(0, 2000)}"
          }
        }
      ]
    },
    "Flaws": {
      "rich_text": [
        {
          "text": {
            "content": "${formData.flaws || 'None noted'}"
          }
        }
      ]
    }
  }
}

Make the actual HTTP request now. Don't simulate - use real curl or fetch. Return the response.`;

                await window.Poe.sendUserMessage(notionPrompt, {
                    handler: "notion-saver",
                    stream: false,
                    openChat: false
                });

            } catch (error) {
                showAlert('Failed to save to Notion. Please try again.');
                resetNotionButton();
            }
        }

        function collectAllFormData() {
            return {
                itemType: document.getElementById('item-type').value,
                brand: document.getElementById('brand').value,
                size: document.getElementById('size').value,
                era: document.getElementById('era').value,
                material1: document.getElementById('material1').value,
                material2: document.getElementById('material2').value,
                condition: document.getElementById('condition').value,
                fit: document.getElementById('fit').value,
                length: document.getElementById('length').value,
                color: getSelectedColors(),
                pattern: document.getElementById('pattern').value,
                measurements: document.getElementById('measurements').value,
                flaws: document.getElementById('flaws').value,
                customFeatures: document.getElementById('custom-features').value,
                fabricTexture: document.getElementById('fabric-texture').value,
                styleAesthetic: document.getElementById('style-aesthetic').value,
                fitNotes: document.getElementById('fit-notes').value
            };
        }

        function resetNotionButton() {
            const saveBtn = document.getElementById('save-notion-btn');
            const saveText = document.getElementById('save-notion-text');
            const saveLoading = document.getElementById('save-notion-loading');
            
            saveBtn.disabled = false;
            saveText.classList.remove('hidden');
            saveLoading.classList.add('hidden');
        }

        function showSuccessAlert(message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <div class="text-center">
                        <div class="text-4xl mb-4">✅</div>
                        <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                        <button class="px-6 py-2 bg-green-500 text-white hover:bg-green-600 rounded" onclick="this.closest('.fixed').remove()">Awesome!</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showAlert(message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <div class="flex justify-end">
                        <button class="px-4 py-2 bg-primary text-white hover:bg-primary-hover rounded" onclick="this.closest('.fixed').remove()">OK</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // ============ BACKUP METHODS FOR NOTION ============

        async function generateCurlCommand() {
            // Validate that we have title and description generated
            const generatedTitle = document.getElementById('generated-title').textContent;
            const descriptionSectionVisible = !document.getElementById('description-section').classList.contains('hidden');
            
            if (!currentDescription || !generatedTitle || !descriptionSectionVisible) {
                showAlert('Please generate the listing first before creating the curl command.');
                return;
            }

            // Collect all form data
            const formData = collectAllFormData();
            
            // Map item type to category
            const itemTypeMapping = {
                'dress': 'Dresses', 'midi dress': 'Dresses', 'maxi dress': 'Dresses',
                'skirt': 'Skirts', 'midi skirt': 'Skirts', 'mini skirt': 'Skirts',
                'jeans': 'Jeans', 'vintage jeans': 'Jeans', 'mom jeans': 'Jeans',
                'trousers': 'Trousers', 'pants': 'Trousers',
                'shorts': 'Shorts', 'denim shorts': 'Shorts',
                'blazer': 'Blazers', 'vintage blazer': 'Blazers',
                'shirt': 'Shirts and Blouses', 'blouse': 'Shirts and Blouses',
                'top': 'Tops', 'tank top': 'Tops', 'crop top': 'Tops',
                'sweater': 'Knitwear', 'cardigan': 'Knitwear',
                'jacket': 'Coats and Jackets', 'coat': 'Coats and Jackets',
                'heels': 'Shoes', 'boots': 'Shoes', 'sneakers': 'Shoes'
            };

            const conditionMapping = {
                'BNWT': 'Brand new with tags', 'NWOT': 'Brand new without tags', 
                'Very good': 'Very good', 'Good': 'Good', 'Satisfactory': 'Satisfactory'
            };

            const mappedCategory = itemTypeMapping[formData.itemType.toLowerCase()] || 'Tops';
            const mappedCondition = conditionMapping[formData.condition] || 'Good';

            // Create the curl command
            const curlCommand = `curl -X POST "https://api.notion.com/v1/pages" \\
  -H "Authorization: Bearer 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" \\
  -H "Content-Type: application/json" \\
  -H "Notion-Version: 2022-06-28" \\
  -d '{
    "parent": { "database_id": "232a1f71-892c-808a-9013-cb1f0901e834" },
    "properties": {
      "Item": {
        "title": [{ "text": { "content": "${generatedTitle.replace(/"/g, '\\"')}" } }]
      },
      "Brand": {
        "rich_text": [{ "text": { "content": "${(formData.brand || 'Unbranded').replace(/"/g, '\\"')}" } }]
      },
      "Size": {
        "multi_select": [{ "name": "${formData.size.replace(/"/g, '\\"')}" }]
      },
      "Category": {
        "select": { "name": "${mappedCategory}" }
      },
      "Colour": {
        "multi_select": [{ "name": "${formData.color.replace(/"/g, '\\"')}" }]
      },
      "Material": {
        "multi_select": [{ "name": "${formData.material1.replace(/"/g, '\\"')}" }]
      },
      "Condition": {
        "select": { "name": "${mappedCondition}" }
      },
      "Description": {
        "rich_text": [{ "text": { "content": "${currentDescription.replace(/```plaintext\n?/g, '').replace(/```\n?/g, '').substring(0, 2000).replace(/"/g, '\\"').replace(/\n/g, '\\n')}" } }]
      },
      "Flaws": {
        "rich_text": [{ "text": { "content": "${(formData.flaws || 'None noted').replace(/"/g, '\\"')}" } }]
      }
    }
  }'`;

            // Show the curl command in a modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-4xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">📋 Manual Curl Command</h3>
                    <p class="text-gray-600 dark:text-gray-400 text-sm mb-4">Copy this command and run it in your Terminal to add the item to Notion:</p>
                    <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-md mb-4 overflow-x-auto">
                        <pre class="text-sm text-gray-800 dark:text-gray-200 whitespace-pre-wrap break-all">${curlCommand}</pre>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button id="copy-curl-btn" class="px-4 py-2 bg-green-500 text-white hover:bg-green-600 rounded">📋 Copy Command</button>
                        <button class="px-4 py-2 bg-gray-500 text-white hover:bg-gray-600 rounded" onclick="this.closest('.fixed').remove()">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Add copy functionality
            modal.querySelector('#copy-curl-btn').addEventListener('click', async () => {
                try {
                    await navigator.clipboard.writeText(curlCommand);
                    const btn = modal.querySelector('#copy-curl-btn');
                    const original = btn.textContent;
                    btn.textContent = '✅ Copied!';
                    setTimeout(() => btn.textContent = original, 2000);
                } catch (error) {
                    showAlert('Copy failed. Please copy manually from the text box.');
                }
            });
        }

        async function copyFormattedData() {
            // Validate that we have title and description generated
            const generatedTitle = document.getElementById('generated-title').textContent;
            const descriptionSectionVisible = !document.getElementById('description-section').classList.contains('hidden');
            
            if (!currentDescription || !generatedTitle || !descriptionSectionVisible) {
                showAlert('Please generate the listing first before copying data.');
                return;
            }

            // Collect all form data
            const formData = collectAllFormData();
            
            // Collect selected features
            const selectedFeatures = [];
            const checkboxes = document.querySelectorAll('#features-grid input[type="checkbox"]:checked');
            checkboxes.forEach(checkbox => {
                selectedFeatures.push(checkbox.value);
            });

            // Create formatted data for manual entry
            const formattedData = `ITEM DETAILS FOR NOTION DATABASE
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📝 Item (Title): ${generatedTitle}

🏷️ Brand: ${formData.brand || 'Unbranded'}
📏 Size: ${formData.size}
📂 Category: ${getCategoryMapping(formData.itemType)}
🎨 Colour: ${formData.color}
🧵 Material: ${formData.material1}
⭐ Condition: ${getConditionMapping(formData.condition)}

📄 Description:
${currentDescription}

⚠️ Flaws: ${formData.flaws || 'None noted'}

${formData.measurements ? '📐 Measurements: ' + formData.measurements : ''}
${formData.fit ? '👔 Fit: ' + formData.fit : ''}
${formData.length ? '📏 Length: ' + formData.length : ''}
${selectedFeatures.length ? '✨ Features: ' + selectedFeatures.join(', ') : ''}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

💡 Copy this data and manually enter it into your Notion database.
   Make sure to match the field names exactly as they appear above.`;

            // Show the formatted data in a modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-4xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">📄 Formatted Data for Manual Entry</h3>
                    <p class="text-gray-600 dark:text-gray-400 text-sm mb-4">Copy this data and manually enter it into your Notion database:</p>
                    <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-md mb-4 overflow-x-auto">
                        <pre class="text-sm text-gray-800 dark:text-gray-200 whitespace-pre-wrap">${formattedData}</pre>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button id="copy-data-btn-modal" class="px-4 py-2 bg-purple-500 text-white hover:bg-purple-600 rounded">📋 Copy Data</button>
                        <button class="px-4 py-2 bg-gray-500 text-white hover:bg-gray-600 rounded" onclick="this.closest('.fixed').remove()">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Add copy functionality
            modal.querySelector('#copy-data-btn-modal').addEventListener('click', async () => {
                try {
                    await navigator.clipboard.writeText(formattedData);
                    const btn = modal.querySelector('#copy-data-btn-modal');
                    const original = btn.textContent;
                    btn.textContent = '✅ Copied!';
                    setTimeout(() => btn.textContent = original, 2000);
                } catch (error) {
                    showAlert('Copy failed. Please copy manually from the text box.');
                }
            });
        }

        function getCategoryMapping(itemType) {
            const mapping = {
                'dress': 'Dresses', 'midi dress': 'Dresses', 'maxi dress': 'Dresses',
                'skirt': 'Skirts', 'midi skirt': 'Skirts', 'mini skirt': 'Skirts',
                'jeans': 'Jeans', 'vintage jeans': 'Jeans', 'mom jeans': 'Jeans',
                'trousers': 'Trousers', 'pants': 'Trousers',
                'shorts': 'Shorts', 'denim shorts': 'Shorts',
                'blazer': 'Blazers', 'vintage blazer': 'Blazers',
                'shirt': 'Shirts and Blouses', 'blouse': 'Shirts and Blouses',
                'top': 'Tops', 'tank top': 'Tops', 'crop top': 'Tops',
                'sweater': 'Knitwear', 'cardigan': 'Knitwear',
                'jacket': 'Coats and Jackets', 'coat': 'Coats and Jackets',
                'heels': 'Shoes', 'boots': 'Shoes', 'sneakers': 'Shoes'
            };
            return mapping[itemType.toLowerCase()] || 'Tops';
        }

        function getConditionMapping(condition) {
            const mapping = {
                'BNWT': 'Brand new with tags', 'NWOT': 'Brand new without tags', 
                'Very good': 'Very good', 'Good': 'Good', 'Satisfactory': 'Satisfactory'
            };
            return mapping[condition] || 'Good';
        }

        // ============ COLOR SELECTION LIMIT FUNCTIONALITY ============

        function setupColorSelectionLimit() {
            const colorCheckboxes = document.querySelectorAll('.color-checkbox');
            const maxColors = 2;

            colorCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const checkedColors = document.querySelectorAll('.color-checkbox:checked');
                    
                    if (checkedColors.length > maxColors) {
                        // Uncheck the current checkbox if limit exceeded
                        this.checked = false;
                        showAlert(`You can select up to ${maxColors} colors only.`);
                        return;
                    }

                    // Update validation for required colors
                    updateColorValidation();
                });
            });
        }

        function updateColorValidation() {
            const checkedColors = document.querySelectorAll('.color-checkbox:checked');
            const generateBtn = document.getElementById('generate-btn');
            
            // Update the form data collection to use selected colors
            if (checkedColors.length === 0) {
                // No colors selected - should show validation error
            } else {
                // At least one color selected - valid
            }
        }

        function getSelectedColors() {
            const checkedColors = document.querySelectorAll('.color-checkbox:checked');
            const colors = [];
            checkedColors.forEach(checkbox => {
                colors.push(checkbox.value);
            });
            return colors.join(', ');
        }

        // ============ VINTED-OPTIMIZED HASHTAG SYSTEM ============

        const VINTED_HASHTAG_DATABASE = {
            // ITEM TYPES - What buyers search for on Vinted (High Priority)
            itemTypes: {
                'dress': ['#Dress', '#VintageDress', '#MidiDress', '#PartyDress', '#SummerDress'],
                'midi dress': ['#MidiDress', '#Dress', '#VintageDress', '#WorkDress', '#ElegantDress'],
                'maxi dress': ['#MaxiDress', '#LongDress', '#VintageDress', '#SummerDress', '#FlowingDress'],
                'jeans': ['#Jeans', '#MomJeans', '#VintageJeans', '#HighWaisted', '#StraightLeg'],
                'vintage jeans': ['#VintageJeans', '#MomJeans', '#HighWaisted', '#RetroJeans', '#90sJeans'],
                'mom jeans': ['#MomJeans', '#HighWaisted', '#VintageJeans', '#90sStyle', '#RelaxedJeans'],
                'trousers': ['#Trousers', '#HighWaisted', '#WideLeg', '#WorkTrousers', '#SmartCasual'],
                'pants': ['#Pants', '#HighWaisted', '#WideLeg', '#CasualPants', '#VintagePants'],
                'blazer': ['#Blazer', '#VintageBlazer', '#WorkWear', '#TailoredBlazer', '#StructuredBlazer'],
                'vintage blazer': ['#VintageBlazer', '#Blazer', '#PowerSuit', '#RetroStyle', '#WorkWear'],
                'shirt': ['#Shirt', '#ButtonUp', '#VintageShirt', '#OversizedShirt', '#CasualShirt'],
                'blouse': ['#Blouse', '#VintageBlouse', '#SilkBlouse', '#WorkBlouse', '#ElegantTop'],
                'top': ['#Top', '#VintageTop', '#CasualTop', '#BasicTee', '#CropTop'],
                'tank top': ['#TankTop', '#Camisole', '#SummerTop', '#BasicTank', '#VintageTop'],
                'sweater': ['#Sweater', '#VintageSweater', '#KnitSweater', '#OversizedSweater', '#CozyKnit'],
                'cardigan': ['#Cardigan', '#VintageCardigan', '#KnitCardigan', '#LayeringPiece', '#CozyCardigan'],
                'jacket': ['#Jacket', '#VintageJacket', '#LeatherJacket', '#DenimJacket', '#BomberJacket'],
                'leather jacket': ['#LeatherJacket', '#MotorJacket', '#RockJacket', '#VintageLeather', '#BikerJacket'],
                'denim jacket': ['#DenimJacket', '#JeansJacket', '#VintageDenim', '#ClassicDenim', '#CasualJacket'],
                'skirt': ['#Skirt', '#MidiSkirt', '#MiniSkirt', '#VintageSkirt', '#ALineSkirt'],
                'midi skirt': ['#MidiSkirt', '#ALineSkirt', '#VintageSkirt', '#ElegantSkirt', '#WorkSkirt'],
                'mini skirt': ['#MiniSkirt', '#ShortSkirt', '#VintageSkirt', '#PartySkirt', '#ALineSkirt'],
                'coat': ['#Coat', '#VintageCoat', '#WoolCoat', '#TrenchCoat', '#WinterCoat']
            },

            // BRANDS - Brands Vinted users actively search for (High Priority)
            brands: {
                'zara': ['#Zara', '#ZaraWoman', '#ZaraBasics'],
                'h&m': ['#HM', '#HandM', '#HMConscious'],
                'cos': ['#COS', '#COSWoman', '#MinimalistBrand'],
                'arket': ['#Arket', '#SustainableBrand'],
                'uniqlo': ['#Uniqlo', '#UniqloU', '#JapaneseBrand'],
                'mango': ['#Mango', '#MangoWoman'],
                'massimo dutti': ['#MassimoDutti', '#LuxuryBasics'],
                '& other stories': ['#AndOtherStories', '#OtherStories'],
                'monki': ['#Monki', '#MonkiStyle'],
                'weekday': ['#Weekday', '#WeekdayBrand'],
                'vintage': ['#Vintage', '#VintageStyle', '#TrueVintage'],
                'polo ralph lauren': ['#PoloRalphLauren', '#RalphLauren', '#PrepStyle'],
                'tommy hilfiger': ['#TommyHilfiger', '#TommyClassic'],
                'calvin klein': ['#CalvinKlein', '#CKJeans'],
                'levi\'s': ['#Levis', '#LevisVintage', '#501s'],
                'nike': ['#Nike', '#NikeVintage'],
                'adidas': ['#Adidas', '#AdidasVintage'],
                'asos': ['#ASOS', '#ASOSDesign'],
                'topshop': ['#Topshop', '#TopshopVintage'],
                'urban outfitters': ['#UrbanOutfitters', '#UOExclusive'],
                'brandy melville': ['#BrandyMelville', '#OneSize']
            },

            // COLORS - Colors buyers filter by on Vinted (Medium Priority)
            colors: {
                'black': ['#Black', '#AllBlack'],
                'white': ['#White', '#OffWhite'],
                'blue': ['#Blue', '#Navy'],
                'navy': ['#Navy', '#DarkBlue'],
                'red': ['#Red', '#BurgundiRed'],
                'green': ['#Green', '#ForestGreen'],
                'brown': ['#Brown', '#Tan'],
                'beige': ['#Beige', '#Cream'],
                'grey': ['#Grey', '#Gray'],
                'pink': ['#Pink', '#Blush'],
                'purple': ['#Purple', '#Lavender'],
                'yellow': ['#Yellow', '#Mustard'],
                'orange': ['#Orange', '#Rust']
            },

            // MATERIALS - What Vinted buyers care about (Medium Priority)
            materials: {
                'cotton': ['#Cotton', '#100Cotton', '#OrganicCotton'],
                'silk': ['#Silk', '#RealSilk', '#SilkBlend'],
                'wool': ['#Wool', '#PureWool', '#MerinoWool'],
                'linen': ['#Linen', '#PureLinen'],
                'denim': ['#Denim', '#100Cotton'],
                'leather': ['#Leather', '#RealLeather', '#GenuineLeather'],
                'cashmere': ['#Cashmere', '#PureCashmere'],
                'polyester': ['#Polyester'],
                'viscose': ['#Viscose', '#Rayon']
            },

            // ERAS - Vintage decades buyers search for (High Priority for vintage)
            eras: {
                '90s': ['#90s', '#90sVintage', '#90sStyle'],
                '80s': ['#80s', '#80sVintage', '#PowerDressing'],
                '70s': ['#70s', '#70sVintage', '#BohoStyle'],
                '60s': ['#60s', '#60sVintage', '#ModStyle'],
                '2000s': ['#Y2K', '#2000s', '#Y2KStyle'],
                '2000s / y2k': ['#Y2K', '#2000sStyle', '#NoughtsStyle']
            },

            // AESTHETICS - Style trends on Vinted (High Priority)
            aesthetics: {
                'y2k': ['#Y2K', '#2000sStyle', '#Y2KFashion'],
                'dark academia': ['#DarkAcademia', '#Academia'],
                'cottagecore': ['#Cottagecore', '#CottageStyle'],
                'minimalist': ['#Minimalist', '#MinimalStyle'],
                'grunge': ['#Grunge', '#GrungeStyle', '#90sGrunge'],
                'preppy': ['#Preppy', '#PrepStyle'],
                'boho': ['#Boho', '#BohoStyle'],
                'vintage': ['#Vintage', '#VintageStyle'],
                'streetwear': ['#Streetwear', '#StreetStyle'],
                'old money': ['#OldMoney', '#QuietLuxury'],
                'scandi': ['#Scandinavian', '#Nordic'],
                'romantic': ['#Romantic', '#Feminine'],
                'coquette': ['#Coquette', '#Girly'],
                'clean girl': ['#CleanGirl', '#EffortlessStyle']
            },

            // OCCASIONS - How buyers plan to wear items (Medium Priority)
            occasions: {
                'work/office': ['#WorkWear', '#Professional'],
                'casual/everyday': ['#Casual', '#Everyday'],
                'evening/party': ['#PartyWear', '#GoingOut'],
                'weekend': ['#Weekend', '#Relaxed'],
                'university/school': ['#Student', '#Campus'],
                'date night': ['#DateNight', '#Evening']
            },

            // FITS - Popular fit searches on Vinted (Medium Priority)
            fits: {
                'oversized': ['#Oversized', '#BaggyFit'],
                'high waisted': ['#HighWaisted', '#HighWaist'],
                'cropped': ['#Cropped', '#CropTop'],
                'wide leg': ['#WideLeg', '#FlowingFit'],
                'straight leg': ['#StraightLeg', '#ClassicFit'],
                'slim fit': ['#SlimFit', '#Fitted'],
                'bodycon': ['#Bodycon', '#TightFit'],
                'a-line': ['#ALine', '#FlatteringFit'],
                'tailored': ['#Tailored', '#Structured']
            },

            // SEASONS - Seasonal searches (Low Priority)
            seasons: {
                'summer': ['#Summer', '#SummerWear'],
                'winter': ['#Winter', '#WinterWear']
            },

            // VINTED COMMUNITY TRENDS - Popular on the platform (Medium Priority)
            vintedTrends: [
                '#VintedFind', '#SecondHand', '#PreLoved', '#SustainableCloset', 
                '#SlowFashion', '#VintageFinds', '#ThriftFind', '#RareFind',
                '#OneOfAKind', '#QualityPiece', '#InvestmentPiece', '#TimelessStyle',
                '#UpcycledFashion', '#EcoFriendly', '#ConsciousFashion', '#StatementPiece'
            ]
        };

        function generateSmartHashtags(data) {
            const selectedTags = new Set();
            const maxHashtags = 10;
            
            // Priority scoring system
            const priorityWeights = {
                itemType: 3,    // Most important - what the item is
                brand: 2.5,     // Very important for brand searches
                era: 2.5,       // High for vintage items
                aesthetic: 2,   // Important for style tribes
                color: 1.5,     // Medium importance
                material: 1.5,  // Medium importance  
                fit: 1,         // Lower priority
                occasion: 1,    // Lower priority
                season: 0.5,    // Lowest priority
                trending: 1.5   // Medium importance for discoverability
            };

            // 1. Always include primary item type (highest priority)
            const itemTypeLower = data.itemType.toLowerCase();
            if (VINTED_HASHTAG_DATABASE.itemTypes[itemTypeLower]) {
                const itemTags = VINTED_HASHTAG_DATABASE.itemTypes[itemTypeLower].slice(0, 2);
                itemTags.forEach(tag => selectedTags.add(tag));
            }

            // 2. Add brand if available (high priority)
            if (data.brand) {
                const brandLower = data.brand.toLowerCase();
                if (VINTED_HASHTAG_DATABASE.brands[brandLower]) {
                    selectedTags.add(VINTED_HASHTAG_DATABASE.brands[brandLower][0]);
                }
            }

            // 3. Add era/decade (high priority for vintage)
            if (data.era && data.era !== 'Unspecified Vintage') {
                const eraLower = data.era.toLowerCase();
                if (VINTED_HASHTAG_DATABASE.eras[eraLower]) {
                    selectedTags.add(VINTED_HASHTAG_DATABASE.eras[eraLower][0]);
                }
            }

            // 4. Add aesthetic/style (high priority)
            if (data.styleAesthetic) {
                const aestheticLower = data.styleAesthetic.toLowerCase();
                if (VINTED_HASHTAG_DATABASE.aesthetics[aestheticLower]) {
                    selectedTags.add(VINTED_HASHTAG_DATABASE.aesthetics[aestheticLower][0]);
                }
            }

            // 5. Add color (medium priority)
            if (data.color) {
                const colorLower = data.color.toLowerCase();
                if (VINTED_HASHTAG_DATABASE.colors[colorLower]) {
                    selectedTags.add(VINTED_HASHTAG_DATABASE.colors[colorLower][0]);
                }
            }

            // 6. Add primary material (medium priority)
            if (data.material1) {
                const materialLower = data.material1.toLowerCase();
                if (VINTED_HASHTAG_DATABASE.materials[materialLower]) {
                    selectedTags.add(VINTED_HASHTAG_DATABASE.materials[materialLower][0]);
                }
            }

            // 7. Add fit style (lower priority)
            if (data.fit) {
                const fitLower = data.fit.toLowerCase();
                if (VINTED_HASHTAG_DATABASE.fits[fitLower]) {
                    selectedTags.add(VINTED_HASHTAG_DATABASE.fits[fitLower][0]);
                }
            }

            // 8. Add season if relevant (lower priority)
            if (data.season) {
                const seasonLower = data.season.toLowerCase();
                if (VINTED_HASHTAG_DATABASE.seasons[seasonLower]) {
                    selectedTags.add(VINTED_HASHTAG_DATABASE.seasons[seasonLower][0]);
                }
            }

            // 9. Fill remaining slots with Vinted community trends
            const remainingSlots = maxHashtags - selectedTags.size;
            if (remainingSlots > 0) {
                const trendingTags = VINTED_HASHTAG_DATABASE.vintedTrends.slice(0, remainingSlots);
                trendingTags.forEach(tag => selectedTags.add(tag));
            }

            // Convert to array and ensure exactly 10 hashtags
            const finalTags = Array.from(selectedTags).slice(0, maxHashtags);
            
            // Add fallback tags if we don't have enough
            while (finalTags.length < maxHashtags) {
                const fallbackTags = ['#VintageStyle', '#ThriftFind', '#SustainableFashion', '#ClassicStyle', '#TimelessPiece'];
                for (const tag of fallbackTags) {
                    if (!finalTags.includes(tag) && finalTags.length < maxHashtags) {
                        finalTags.push(tag);
                    }
                }
                break; // Prevent infinite loop
            }

            return finalTags.join(' ');
        }

        // ============ API KEY MANAGEMENT ============

        function setupApiKeyManagement() {
            const toggleBtn = document.getElementById('toggle-api-key');
            const statusDiv = document.getElementById('api-key-status');
            const inputDiv = document.getElementById('api-key-input');
            const keyField = document.getElementById('api-key-field');
            const saveBtn = document.getElementById('save-api-key');
            const clearBtn = document.getElementById('clear-api-key');

            // Check if API key exists and update status
            updateApiKeyStatus();

            toggleBtn.addEventListener('click', () => {
                if (inputDiv.classList.contains('hidden')) {
                    inputDiv.classList.remove('hidden');
                    toggleBtn.textContent = 'Cancel';
                } else {
                    inputDiv.classList.add('hidden');
                    toggleBtn.textContent = 'Enter Key';
                    keyField.value = '';
                }
            });

            saveBtn.addEventListener('click', () => {
                const apiKey = keyField.value.trim();
                if (apiKey && apiKey.startsWith('sk-')) {
                    // Use the same storage fallback system
                    sessionApiKey = apiKey;
                    try {
                        localStorage.setItem('openai_api_key', apiKey);
                    } catch (e) {
                        try {
                            sessionStorage.setItem('openai_api_key', apiKey);
                        } catch (e2) {
                            console.log('Storage blocked, API key will only persist for this session');
                        }
                    }
                    updateApiKeyStatus();
                    inputDiv.classList.add('hidden');
                    toggleBtn.textContent = 'Change Key';
                    keyField.value = '';
                    showAlert('✅ API key saved successfully!');
                } else {
                    showAlert('❌ Please enter a valid OpenAI API key (starts with sk-)');
                }
            });

            clearBtn.addEventListener('click', () => {
                sessionApiKey = null;
                try {
                    localStorage.removeItem('openai_api_key');
                } catch (e) {
                    try {
                        sessionStorage.removeItem('openai_api_key');
                    } catch (e2) {
                        console.log('Storage blocked, clearing from memory only');
                    }
                }
                updateApiKeyStatus();
                inputDiv.classList.add('hidden');
                toggleBtn.textContent = 'Enter Key';
                keyField.value = '';
                showAlert('🗑️ API key cleared');
            });

            keyField.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    saveBtn.click();
                }
            });
        }

        function updateApiKeyStatus() {
            const statusDiv = document.getElementById('api-key-status');
            const toggleBtn = document.getElementById('toggle-api-key');
            
            let apiKey = sessionApiKey;
            if (!apiKey) {
                try {
                    apiKey = localStorage.getItem('openai_api_key');
                } catch (e) {
                    try {
                        apiKey = sessionStorage.getItem('openai_api_key');
                    } catch (e2) {
                        // Both storage methods blocked, use memory only
                    }
                }
            }

            if (apiKey) {
                statusDiv.textContent = `✅ API key configured (${apiKey.substring(0, 7)}...)`;
                toggleBtn.textContent = 'Change Key';
            } else {
                statusDiv.textContent = 'No API key set - click "Enter Key" to add yours';
                toggleBtn.textContent = 'Enter Key';
            }
        }
    </script>


</body></html>